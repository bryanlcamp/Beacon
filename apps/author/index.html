<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Author - Beacon HFT Platform</title>

        <!-- Import Beacon Design System -->
        <link rel="stylesheet" href="/assets/css/common/page-gradients/navy-page-gradient.css">
        <link rel="stylesheet" href="/assets/fonts/inter/inter-local.css">

        <!-- Reusable Components -->
        <link rel="stylesheet" href="/assets/css/components/glass-panels.css">
        <link rel="stylesheet" href="/assets/css/components/interactive-icons.css">
        <link rel="stylesheet" href="/assets/css/components/typography.css">
        <link rel="stylesheet" href="/assets/css/components/dropdowns.css">
        <link rel="stylesheet" href="/assets/css/animations/core-animations.css">

        <!-- Page-specific styles for Author app -->
        <link rel="stylesheet" href="/assets/css/pages/command-center/command-center-utilities.css">
        <link rel="stylesheet" href="/assets/css/pages/command-center/command-center-base.css">

        <!-- Author app specific styles -->
        <style>
            :root {
                /* Beacon color system - matching main site */
                --color-orange: #ff914d;
                --color-blue: #6bb6ff;
                --color-white: #fff;
                --color-red: #ff5858;

                /* Glass panel backgrounds */
                --glass-panel: rgba(16, 22, 36, 0.8);
                --glass-input: rgba(24, 31, 46, 0.8);

                /* Border colors */
                --border-blue: rgba(107, 182, 255, 0.2);
                --border-blue-active: rgba(107, 182, 255, 0.6);
                --border-red: rgba(255, 88, 88, 0.6);

                /* Spacing */
                --spacing-xs: 0.5em;
                --spacing-sm: 0.75em;
                --spacing-md: 1em;
                --spacing-lg: 1.5em;
                --spacing-xl: 2em;
            }

            html,
            body {
                overflow-y: auto;
                scroll-behavior: smooth;
            }

            body {
                font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
                background: #0a0a15;
                color: #ffffff;
                margin: 0;
                padding: 0;
                min-height: 100vh;
            }

            .beacon-page-header {
                background: rgba(16, 22, 36, 0.9);
                backdrop-filter: blur(10px);
                padding: 1em 2em;
                border-bottom: 1px solid rgba(107, 182, 255, 0.2);
            }

            .beacon-page-nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1400px;
                margin: 0 auto;
            }

            .beacon-brand-header {
                display: flex;
                align-items: center;
                gap: 1em;
            }

            .beacon-brand-main {
                color: #6bb6ff;
                text-decoration: none;
                font-size: 1.5em;
                font-weight: 900;
            }

            .beacon-brand-separator {
                color: rgba(255, 255, 255, 0.5);
            }

            .beacon-page-title {
                color: #ffffff;
                font-size: 1.5em;
                font-weight: 700;
                margin: 0;
            }

            .beacon-nav-actions {
                display: flex;
                align-items: center;
                gap: 1.5em;
            }

            .beacon-nav-back {
                color: #6bb6ff;
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 0.5em;
                transition: color 0.3s ease;
            }

            .beacon-nav-back:hover {
                color: #ffffff;
            }

            .beacon-page-content {
                max-width: 1400px;
                margin: 2em auto;
                padding: 0 2em;
            }

            .app-layout {
                display: grid;
                grid-template-columns: 320px 1fr;
                gap: 2em;
                min-height: 600px;
            }

            .config-panel,
            .datacards-panel {
                background: rgba(16, 22, 36, 0.8);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(107, 182, 255, 0.2);
                border-radius: 12px;
                padding: 1.5em;
            }

            .form-group {
                margin-bottom: 1.5em;
            }

            .config-section {
                margin-bottom: 1.5em;
            }

            .spinner-input,
            .symbol-input,
            .exchange-select,
            .form-select {
                width: 100%;
                background: rgba(24, 31, 46, 0.8);
                border: 1px solid rgba(107, 182, 255, 0.3);
                border-radius: 6px;
                padding: 0.75em;
                color: #ffffff;
                font-family: inherit;
            }

            /* Hide browser's default number input arrows */
            .spinner-input::-webkit-outer-spin-button,
            .spinner-input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .spinner-input[type=number] {
                -moz-appearance: textfield;
                appearance: textfield;
            }

            .exchange-select {
                appearance: none !important;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'%3e%3cpolyline points='6,9 12,15 18,9' stroke='%23ffffff99' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e") !important;
                background-position: right 12px center !important;
                background-repeat: no-repeat !important;
                background-size: 16px !important;
                padding-right: 40px !important;
            }

            .spinner-input:focus,
            .symbol-input:focus,
            .exchange-select:focus {
                outline: none;
                border-color: #6bb6ff;
                box-shadow: 0 0 0 2px rgba(107, 182, 255, 0.2);
            }

            .btn {
                background: #6bb6ff;
                color: #ffffff;
                border: none;
                border-radius: 6px;
                padding: 0.75em 1.5em;
                font-family: inherit;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 0.5em;
            }

            .btn:hover {
                background: #5aa3e6;
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: rgba(107, 182, 255, 0.1);
                color: #6bb6ff;
                border: 1px solid rgba(107, 182, 255, 0.3);
            }

            .btn-secondary:hover {
                background: rgba(107, 182, 255, 0.2);
                color: #ffffff;
            }

            .config-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 0.75em;
            }

            .demo-banner {
                background: rgba(255, 145, 77, 0.1);
                border: 1px solid rgba(255, 145, 77, 0.3);
                color: #ff914d;
                padding: 0.75em;
                text-align: center;
                margin: 1em 2em;
                border-radius: 8px;
            }

            .datacard-container {
                display: grid;
                gap: 1em;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }

            .range-control-group {
                display: flex;
                gap: 1em;
                margin-bottom: 1em;
            }

            .range-control.half-width {
                flex: 1;
            }

            .advanced-toggle {
                display: flex;
                align-items: center;
                gap: 0.5em;
                padding: 0.5em;
                margin: 0.5em 0;
                background: linear-gradient(90deg, #6bb6ff, #3a7afe);
                color: white;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.85em;
                font-weight: 500;
                transition: all 0.2s ease;
                user-select: none;
            }

            .advanced-toggle:hover {
                background: linear-gradient(90deg, #5aa5ef, #2969ee);
                transform: translateY(-1px);
            }

            .advanced-chevron {
                transition: transform 0.2s ease;
            }

            .advanced-toggle.expanded .advanced-chevron {
                transform: rotate(180deg);
            }

            /* Section styling */
            .section-title {
                color: #ffffff;
                font-size: 1.4em;
                font-weight: 600;
                margin: 0 0 1.5em 0;
                padding-bottom: 0.5em;
                border-bottom: 1px solid rgba(107, 182, 255, 0.2);
            }

            .section-separator {
                height: 1px;
                background: linear-gradient(90deg, transparent, rgba(107, 182, 255, 0.3), transparent);
                margin: 1.5em 0;
            }

            .input-label {
                display: block;
                color: rgba(255, 255, 255, 0.9);
                font-size: 0.95em;
                font-weight: 500;
                margin-bottom: 0.5em;
            }

            /* Percentage Allocation Display */
            .allocation-display {
                background: rgba(24, 31, 46, 0.9);
                border: 2px solid rgba(107, 182, 255, 0.3);
                border-radius: 8px;
                padding: 1.5em;
                margin: 1em 0;
                text-align: center;
                transition: all 0.3s ease;
            }

            .allocation-display.invalid {
                border-color: rgba(255, 88, 88, 0.6);
                background: rgba(255, 88, 88, 0.05);
            }

            .allocation-percentage {
                font-size: 2.2em;
                font-weight: 700;
                margin-bottom: 0.25em;
                color: #6bb6ff;
                transition: color 0.3s ease;
            }

            .allocation-display.invalid .allocation-percentage {
                color: #ff5858;
            }

            .allocation-label {
                font-size: 1.1em;
                color: rgba(255, 255, 255, 0.8);
                font-weight: 500;
            }

            /* Red Adorner for Invalid Percentage Inputs */
            .percentage-input.invalid {
                border-color: #ff5858 !important;
                box-shadow: 0 0 0 2px rgba(255, 88, 88, 0.2) !important;
            }

            .percentage-input.invalid:focus {
                border-color: #ff5858 !important;
                box-shadow: 0 0 0 2px rgba(255, 88, 88, 0.3) !important;
            }

            /* Datacard styling fallback */
            .datacard {
                background: rgba(24, 31, 46, 0.9);
                border: 1px solid rgba(107, 182, 255, 0.2);
                border-radius: 8px;
                padding: 1em;
                margin-bottom: 1em;
            }

            .datacard-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1em;
                padding-bottom: 0.5em;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .symbol-display {
                font-weight: 600;
                color: #ffffff;
                font-size: 1.1em;
                letter-spacing: 0.01em;
                line-height: 1.0;
                margin: 0;
                white-space: nowrap;
            }

            .exchange-prefix {
                color: #6bb6ff;
                margin-right: 0.25em;
                font-weight: 700;
            }

            .symbol-name {
                color: #ffffff;
                font-weight: 800;
            }

            .datacard-controls {
                display: flex;
                align-items: center;
                gap: 0.5em;
            }

            .percentage-input {
                width: 60px;
                background: rgba(24, 31, 46, 0.8);
                border: 1px solid rgba(107, 182, 255, 0.3);
                border-radius: 4px;
                padding: 0.5em;
                color: #ffffff;
                font-family: inherit;
                text-align: center;
            }

            .remove-symbol {
                background: rgba(255, 88, 88, 0.1);
                border: 1px solid rgba(255, 88, 88, 0.3);
                color: #ff5858;
                border-radius: 4px;
                width: 24px;
                height: 24px;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .remove-symbol:hover {
                background: rgba(255, 88, 88, 0.2);
                border-color: #ff5858;
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .app-layout {
                    grid-template-columns: 1fr;
                }

                .config-actions {
                    justify-content: center;
                }
            }

            /* Datacard styling fallback */
            .datacard {
                background: rgba(24, 31, 46, 0.9);
                border: 1px solid rgba(107, 182, 255, 0.2);
                border-radius: 8px;
                padding: 1em;
                margin-bottom: 1em;
            }

            .datacard-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1em;
                padding-bottom: 0.5em;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .symbol-display {
                font-weight: 600;
                color: #ffffff;
                font-size: 1.1em;
                letter-spacing: 0.01em;
                line-height: 1.0;
                margin: 0;
                white-space: nowrap;
            }

            .exchange-prefix {
                color: #6bb6ff;
                margin-right: 0.25em;
                font-weight: 700;
            }

            .symbol-name {
                color: #ffffff;
                font-weight: 800;
            }

            .datacard-controls {
                display: flex;
                align-items: center;
                gap: 0.5em;
            }

            .percentage-input {
                width: 60px;
                background: rgba(16, 22, 36, 0.8);
                border: 1px solid rgba(107, 182, 255, 0.3);
                border-radius: 4px;
                padding: 0.25em 0.5em;
                color: #ffffff;
                font-size: 0.85em;
            }

            .remove-symbol {
                background: transparent;
                border: none;
                color: #ff5858;
                font-size: 1.2em;
                font-weight: bold;
                cursor: pointer;
                padding: 0.25em 0.5em;
                border-radius: 4px;
                transition: background 0.2s;
            }

            .remove-symbol:hover {
                background: rgba(255, 88, 88, 0.1);
            }

            .datacard-content {
                margin-top: 1em;
            }

            .range-control {
                margin-bottom: 0.75em;
            }

            .range-label {
                color: rgba(255, 255, 255, 0.8);
                font-size: 0.85em;
                margin-bottom: 0.5em;
                display: block;
            }

            .range-input {
                width: 100%;
                margin-bottom: 0.25em;
            }

            .range-value {
                color: #6bb6ff;
                font-weight: 600;
                font-size: 0.9em;
            }
        </style>
    </head>

    <body>

        <!-- Adjust page content for demo banner -->
        <style>
            .beacon-page-content {
                padding-top: 140px !important;
                /* Account for demo banner */
            }
        </style>

        <!-- Global Demo Mode Configuration -->
        <script>
            // Demo mode detection - globally accessible
            const IS_DEMO_MODE = true; // Set to true for demo deployment

            // Show demo banner immediately if in demo mode
            if (IS_DEMO_MODE) {
                document.addEventListener('DOMContentLoaded', function () {
                    const banner = document.getElementById('demo-banner');
                    if (banner) {
                        banner.style.display = 'block';
                    }
                });
            }
        </script>

        <!-- Beacon Title Header -->
        <header class="beacon-page-header">
            <nav class="beacon-page-nav">
                <div class="beacon-brand-header">
                    <a href="/" class="beacon-brand-main">Beacon.</a>
                    <span class="beacon-brand-separator"
                        style="color: #ff914d; text-shadow: 0 0 8px rgba(255, 145, 77, 0.4); font-weight: 600; margin: 0 1em;">|</span>
                    <h1 class="beacon-page-title">Author.</h1>
                </div>
                <div class="beacon-nav-actions">
                    <a href="/" class="beacon-nav-back">
                        <span class="nav-arrow">‚Üê</span>
                        <span>Home</span>
                    </a>
                    <div class="utility-icons">
                        <div class="utility-icon" id="infoIcon" style="position: relative;">
                            <img src="/assets/images/icons/info-orange.svg" alt="Information"
                                style="width:20px;height:20px;" />
                            <div class="info-dropdown" id="infoDropdown"
                                style="display:none;position:absolute;right:0;top:110%;min-width:120px;background:#181828;border:1.5px solid #ff914d;border-radius:8px;box-shadow:0 4px 16px 0 rgba(0,0,0,0.3);z-index:100;padding:0.5em 0;text-align:left;">
                                <a href="mailto:contact@beaconhft.com"
                                    style="display:block;color:#fff;text-decoration:none;padding:0.5em 1.2em;font-size:1em;transition:background 0.18s,color 0.18s;">Contact</a>
                                <a href="/command-center/about.html"
                                    style="display:block;color:#fff;text-decoration:none;padding:0.5em 1.2em;font-size:1em;transition:background 0.18s,color 0.18s;">About</a>
                            </div>
                        </div>
                        <div class="utility-icon" id="searchIcon" style="position: relative;">
                            <img src="/assets/images/icons/search-orange.svg" alt="Search"
                                style="width:20px;height:20px;" />
                            <div class="search-dropdown" id="searchDropdown">
                                <input type="text" class="search-input" placeholder="Search datasets, parameters..." />
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Demo Mode Banner -->
        <div id="demo-banner" class="demo-banner"
            style="display: block; background: linear-gradient(90deg, #6bb6ff, #3a7afe); border: 2px solid rgba(58, 122, 254, 0.4); color: white; padding: 1em; text-align: center; margin: 1em 2em; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            <div class="demo-content">
                <span class="demo-text">Demo Mode - UI Look & Feel.</span>
            </div>
        </div>

        <!-- Main Application -->
        <main class="beacon-page-content" id="app-container">

            <!-- Two-Panel Layout -->
            <div class="app-layout" role="application" aria-label="Dataset Generator">

                <!-- Left Panel: Configuration -->
                <section class="config-panel" aria-labelledby="config-panel-title">
                    <!-- Dataset Creation Section -->
                    <div class="config-section">
                        <h2 class="section-title">Dataset Creation</h2>

                        <!-- Format Dropdowns -->
                        <div class="form-group">
                            <label for="outputFormat" class="input-label" style="text-align: left;">Format</label>
                            <div style="display: flex; gap: 12px;">
                                <select id="exchangeSelect" class="form-select" style="flex: 1;">
                                    <option value="CME">CME</option>
                                    <option value="NASDAQ">NASDAQ</option>
                                    <option value="NYSE">NYSE</option>
                                </select>
                                <select id="outputFormat2" class="form-select" style="flex: 1;">
                                    <option value="CME">CME</option>
                                    <option value="NASDAQ">NASDAQ</option>
                                    <option value="NYSE">NYSE</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Blue Separator -->
                    <div class="section-separator"></div>

                    <!-- Add Symbol Section -->
                    <div class="config-section">
                        <h3 class="section-title" style="font-size: 1.2em; margin-bottom: 1em;">Add Product</h3>
                        <div class="form-group">
                            <label for="symbolInput" class="input-label">Symbol</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="symbolInput" class="symbol-input"
                                    placeholder="Enter symbol (e.g., MSFT)" style="flex: 1; text-transform: uppercase;">
                                <button type="button" id="addSymbol" class="btn btn-secondary"
                                    style="padding: 0.75em 1em;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Blue Separator -->
                    <div class="section-separator"></div>

                    <!-- Dataset Parameters Section -->
                    <div class="config-section">
                        <h3 class="section-title" style="font-size: 1.2em; margin-bottom: 1em;">Dataset Parameters</h3>
                        <div class="form-group">
                            <label for="messageCount" class="input-label">Total Messages</label>
                            <div class="spinner-control" style="position: relative;">
                                <input type="number" id="messageCount" class="spinner-input" min="1000" step="500"
                                    value="1000" placeholder="1000">
                                <div
                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column;">
                                    <button type="button" class="spinner-up"
                                        style="border: none; background: transparent; color: #6bb6ff; padding: 2px; cursor: pointer; font-size: 12px;">‚ñ≤</button>
                                    <button type="button" class="spinner-down"
                                        style="border: none; background: transparent; color: #6bb6ff; padding: 2px; cursor: pointer; font-size: 12px;">‚ñº</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Blue Separator -->
                    <div class="section-separator"></div>

                    <!-- Percentage Allocation Display -->
                    <div class="allocation-display" id="allocationDisplay">
                        <div class="allocation-percentage" id="allocationPercentage">0%</div>
                        <div class="allocation-label">Allocated</div>
                    </div>

                    <!-- Config Panel Body -->
                    <div class="panel-body">
                        <div class="config-actions">
                            <!-- Generate Button -->
                            <button type="button" class="btn btn-primary" id="generateDataset"
                                style="margin-left: auto;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                                </svg>
                                Generate
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Right Panel: DataCards -->
                <section class="datacards-panel" aria-labelledby="datacards-panel-title">
                    <header class="panel-header"
                        style="display: flex; justify-content: center; align-items: center; padding: 1em;">
                        <h2 id="datacards-panel-title" class="sr-only">Symbol Configuration Panel</h2>

                        <!-- File Selection Dropdown - Centered -->
                        <div class="dropdown-container" style="position: relative; display: inline-block;">
                            <button type="button" class="btn btn-secondary" id="fileDropdownBtn"
                                style="display: flex; align-items: center; gap: 0.5em;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                </svg>
                                <span id="fileDropdownText">Select File</span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="dropdown-menu" id="fileDropdownMenu"
                                style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); min-width: 200px; background: rgba(16, 22, 36, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(107, 182, 255, 0.3); border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); z-index: 1000; margin-top: 2px; padding: 0.5em 0;">
                                <!-- Dropdown contents will be populated here -->
                                <div
                                    style="padding: 1em; text-align: center; color: rgba(255,255,255,0.5); font-style: italic;">
                                    No files available
                                </div>
                            </div>
                        </div>
                    </header>
                    <!-- Datacard container for dynamic datacards -->
                    <div id="datacardContainer" class="datacard-container"
                        style="margin-top: 18px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 16px;">
                        <!-- Empty container - products will be added dynamically -->
                        <div
                            style="grid-column: 1 / -1; text-align: center; padding: 2em; color: rgba(255, 255, 255, 0.5); font-style: italic;">
                            No products added yet. Use the "Add Product" section to get started.
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Load Dataset Generator Application -->
        <script type="module">
            // Error handling for module loading
            window.addEventListener('error', (e) => {
                console.error('Script error:', e.error);
                showErrorMessage('Failed to load application components');
            });

            window.addEventListener('unhandledrejection', (e) => {
                console.error('Unhandled promise rejection:', e.reason);
                showErrorMessage('Application initialization failed');
            });

            function showErrorMessage(message) {
                const banner = document.getElementById('demo-banner');
                if (banner) {
                    banner.style.display = 'block';
                    banner.querySelector('.demo-text').textContent = `‚ö†Ô∏è ${message}`;
                    banner.style.background = 'rgba(255, 88, 88, 0.1)';
                    banner.style.borderColor = 'rgba(255, 88, 88, 0.3)';
                    banner.style.color = '#ff5858';
                }
            }

            // Only load real application if not in demo mode
            if (!IS_DEMO_MODE) {
                // Dynamic import with fallback
                import('/command-center/apps/dataset-generator/js/DatasetGeneratorApp.js')
                    .then(({ DatasetGeneratorApp }) => {
                        // Initialize app when DOM is ready
                        document.addEventListener('DOMContentLoaded', async () => {
                            try {
                                console.log('üöÄ Starting Dataset Generator Application...');
                                const app = new DatasetGeneratorApp();

                                // Add timeout to detect if initialization hangs
                                const initTimeout = setTimeout(() => {
                                    console.warn('‚ö†Ô∏è App initialization taking longer than expected');
                                    showErrorMessage('Application loading is taking longer than expected. Please check console for details.');
                                }, 5000);

                                await app.initialize();
                                clearTimeout(initTimeout);

                                // Make app globally accessible for debugging
                                window.datasetGeneratorApp = app;

                                console.log('‚úÖ Dataset Generator Application loaded successfully');
                                console.log('Available methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(app)));

                                // Hide demo banner if successful
                                const banner = document.getElementById('demo-banner');
                                if (banner && banner.style.display === 'block') {
                                    banner.style.display = 'none';
                                }

                                // Test symbol manager
                                if (app.symbolManager) {
                                    console.log('‚úÖ SymbolManager is available');
                                    window.symbolManager = app.symbolManager;
                                } else {
                                    console.warn('‚ö†Ô∏è SymbolManager not found in app');
                                }

                            } catch (error) {
                                console.error('‚ùå Failed to initialize Dataset Generator:', error);
                                console.error('Error stack:', error.stack);
                                showErrorMessage('Application initialization failed: ' + error.message);

                                // Enable fallback functionality
                                setupFallbackSymbolInput();
                            }
                        });
                    })
                    .catch((error) => {
                        console.error('‚ùå Failed to load Dataset Generator module:', error);
                        console.error('Module loading error:', error.stack);
                        showErrorMessage('Failed to load application module: ' + error.message);

                        // Enable fallback functionality
                        document.addEventListener('DOMContentLoaded', setupFallbackSymbolInput);
                    });
            } else {
                // Demo mode - only use fallback functionality
                document.addEventListener('DOMContentLoaded', function () {
                    setupFallbackSymbolInput();
                    setupDropdownFunctionality();
                    initializeDemoMode();
                });
            }

            // Create a detailed datacard with sliders (fallback) - Global scope
            window.createDetailedDatacard = function createDetailedDatacard(symbol) {
                const exchange = document.getElementById('exchangeSelect')?.value || 'CME';
                const card = document.createElement('div');
                card.className = 'datacard';

                // Get slider configuration from validation config
                const sliderConfig = validationConfig?.sliderConfig || {};

                // Helper function to get slider attributes
                function getSliderAttrs(configKey, fallbackMin = 1, fallbackMax = 100, fallbackStep = 1, fallbackDefault = 50) {
                    const config = sliderConfig[configKey];
                    if (config) {
                        return {
                            min: config.min,
                            max: config.max,
                            step: config.step,
                            value: config.default
                        };
                    }
                    return {
                        min: fallbackMin,
                        max: fallbackMax,
                        step: fallbackStep,
                        value: fallbackDefault
                    };
                }

                const basePrice = getSliderAttrs('basePrice', 1, 1000, 10, 175);
                const spread = getSliderAttrs('spread', 0.1, 10, 0.1, 0.5);
                const bidPrice = getSliderAttrs('bidPrice', 1, 1000, 1, 174);
                const askPrice = getSliderAttrs('askPrice', 1, 1000, 1, 176);
                const bidQuantity = getSliderAttrs('bidQuantity', 1, 10000, 50, 250);
                const askQuantity = getSliderAttrs('askQuantity', 1, 10000, 50, 300);
                const bidWeight = getSliderAttrs('bidWeight', 0, 100, 5, 45);
                const askWeight = getSliderAttrs('askWeight', 0, 100, 5, 55);
                const volatility = getSliderAttrs('volatility', 0, 100, 5, 25);
                const trend = getSliderAttrs('trend', -50, 50, 5, 5);
                const percentage = getSliderAttrs('percentage', 0, 100, 1, 0);

                card.innerHTML = `
                <div class="datacard-header">
                    <div class="datacard-symbol-info">
                        <span class="symbol-display">
                            <span class="exchange-prefix">${exchange}:</span>
                            <span class="symbol-name">${symbol}</span>
                        </span>
                    </div>
                    <div class="datacard-controls">
                        <input type="number" class="percentage-input" min="${percentage.min}" max="${percentage.max}" step="${percentage.step}" value="${percentage.value}" placeholder="%">
                        <button class="remove-symbol" aria-label="Remove ${symbol}">√ó</button>
                    </div>
                </div>

                <div class="datacard-content">
                    <!-- Default: Spread-based controls -->
                    <div class="pricing-mode-default">
                        <!-- Base Price & Spread -->
                        <div class="range-control-group">
                            <div class="range-control half-width">
                                <div class="range-label">Base Price</div>
                                <input type="range" class="range-input" min="${basePrice.min}" max="${basePrice.max}" step="${basePrice.step}" value="${basePrice.value}">
                                <div class="range-value">$<span class="value">${basePrice.value}</span></div>
                            </div>
                            <div class="range-control half-width">
                                <div class="range-label">Spread</div>
                                <input type="range" class="range-input" min="${spread.min}" max="${spread.max}" step="${spread.step}" value="${spread.value}">
                                <div class="range-value"><span class="value">${spread.value}</span>%</div>
                            </div>
                        </div>

                        <!-- Bid/Ask Weights -->
                        <div class="range-control-group">
                            <div class="range-control half-width">
                                <div class="range-label">Bid Weight</div>
                                <input type="range" class="range-input" min="${bidWeight.min}" max="${bidWeight.max}" step="${bidWeight.step}" value="${bidWeight.value}">
                                <div class="range-value"><span class="value">${bidWeight.value}</span>%</div>
                            </div>
                            <div class="range-control half-width">
                                <div class="range-label">Ask Weight</div>
                                <input type="range" class="range-input" min="${askWeight.min}" max="${askWeight.max}" step="${askWeight.step}" value="${askWeight.value}">
                                <div class="range-value"><span class="value">${askWeight.value}</span>%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Toggle -->
                    <div class="advanced-toggle" onclick="toggleAdvancedMode(this)">
                        <span class="advanced-text">Advanced</span>
                        <span class="advanced-chevron">‚ñº</span>
                    </div>

                    <!-- Advanced: Independent Price Controls (Hidden by default) -->
                    <div class="pricing-mode-advanced" style="display: none;">
                        <!-- Bid/Ask Price -->
                        <div class="range-control-group">
                            <div class="range-control half-width">
                                <div class="range-label">Bid Price</div>
                                <input type="range" class="range-input" min="${bidPrice.min}" max="${bidPrice.max}" step="${bidPrice.step}" value="${bidPrice.value}">
                                <div class="range-value">$<span class="value">${bidPrice.value}</span></div>
                            </div>
                            <div class="range-control half-width">
                                <div class="range-label">Ask Price</div>
                                <input type="range" class="range-input" min="${askPrice.min}" max="${askPrice.max}" step="${askPrice.step}" value="${askPrice.value}">
                                <div class="range-value">$<span class="value">${askPrice.value}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Bid/Ask Quantity (always visible) -->
                    <div class="range-control-group">
                        <div class="range-control half-width">
                            <div class="range-label">Bid Quantity</div>
                            <input type="range" class="range-input" min="${bidQuantity.min}" max="${bidQuantity.max}" step="${bidQuantity.step}" value="${bidQuantity.value}">
                            <div class="range-value"><span class="value">${bidQuantity.value}</span></div>
                        </div>
                        <div class="range-control half-width">
                            <div class="range-label">Ask Quantity</div>
                            <input type="range" class="range-input" min="${askQuantity.min}" max="${askQuantity.max}" step="${askQuantity.step}" value="${askQuantity.value}">
                            <div class="range-value"><span class="value">${askQuantity.value}</span></div>
                        </div>
                    </div>

                    <!-- Volatility & Trend (side by side) -->
                    <div class="range-control-group">
                        <div class="range-control half-width">
                            <div class="range-label">Volatility</div>
                            <input type="range" class="range-input" min="${volatility.min}" max="${volatility.max}" step="${volatility.step}" value="${volatility.value}">
                            <div class="range-value"><span class="value">${volatility.value}</span>%</div>
                        </div>

                        <div class="range-control half-width">
                            <div class="range-label">Trend</div>
                            <input type="range" class="range-input" min="${trend.min}" max="${trend.max}" step="${trend.step}" value="${trend.value}">
                            <div class="range-value"><span class="value">${trend.value}</span> (${trend.value === 0 ? 'Neutral' : trend.value > 0 ? 'Bullish' : 'Bearish'})</div>
                        </div>
                    </div>
                </div>
            `;

                // Add event listeners
                const removeBtn = card.querySelector('.remove-symbol');
                removeBtn.addEventListener('click', () => {
                    // Remove from percentage tracking
                    productPercentages.delete(symbol);
                    card.remove();

                    // Redistribute percentages after removal
                    redistributeCleanPercentages();
                    updateAllocationDisplay();
                });

                // Add percentage input validation
                const percentageInput = card.querySelector('.percentage-input');
                if (percentageInput) {
                    // Initialize this product in our tracking
                    const initialValue = parseInt(percentageInput.value) || 0;
                    productPercentages.set(symbol, { percentage: initialValue, isDirty: false });

                    percentageInput.addEventListener('input', (e) => {
                        validatePercentageInput(e.target);
                    });

                    percentageInput.addEventListener('change', (e) => {
                        validatePercentageInput(e.target);
                    });
                }

                // Update range values
                const ranges = card.querySelectorAll('.range-input');
                ranges.forEach(range => {
                    range.addEventListener('input', (e) => {
                        const parent = e.target.closest('.range-control');
                        const valueDisplay = parent.querySelector('.range-value');
                        const value = e.target.value;

                        if (valueDisplay) {
                            const valueSpan = valueDisplay.querySelector('.value');
                            if (valueSpan) {
                                valueSpan.textContent = value;

                                // Update trend description dynamically
                                if (parent.querySelector('.range-label').textContent === 'Trend') {
                                    const trendValue = parseInt(value);
                                    const description = trendValue === 0 ? 'Neutral' : trendValue > 0 ? 'Bullish' : 'Bearish';
                                    valueSpan.parentNode.innerHTML = `<span class="value">${value}</span> (${description})`;
                                }
                            }
                        }
                    });
                });

                return card;
            }

            // Add aliases for any missing function references
            window.createSimpleDataCard = window.createDetailedDatacard;
            window.createDataCard = window.createDetailedDatacard;

            // Fallback symbol functionality if the main app fails
            function setupFallbackSymbolInput() {
                const symbolInput = document.getElementById('symbolInput');
                const addSymbolBtn = document.getElementById('addSymbol');
                const datacardContainer = document.getElementById('datacardContainer');

                if (symbolInput && addSymbolBtn && datacardContainer) {
                    // Remove any existing listeners
                    const newAddBtn = addSymbolBtn.cloneNode(true);
                    addSymbolBtn.parentNode.replaceChild(newAddBtn, addSymbolBtn);

                    newAddBtn.addEventListener('click', () => {
                        const symbol = symbolInput.value.trim().toUpperCase();
                        if (symbol && !document.querySelector(`[data-symbol="${symbol}"]`)) {
                            // Calculate auto-allocation percentage
                            const autoPercentage = redistributeCleanPercentages();

                            // Create new datacard with auto-allocated percentage
                            const newCard = createDetailedDatacard(symbol);
                            const newPercentageInput = newCard.querySelector('.percentage-input');
                            if (newPercentageInput) {
                                newPercentageInput.value = autoPercentage;

                                // Mark as clean since it's auto-allocated
                                productPercentages.set(symbol, { percentage: autoPercentage, isDirty: false });
                            }

                            datacardContainer.appendChild(newCard);
                            symbolInput.value = '';

                            // Update display after adding
                            updateAllocationDisplay();
                        }
                    });

                    symbolInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            newAddBtn.click();
                        }
                    });
                }
            }

            // Make toggleAdvancedMode globally accessible
            window.toggleAdvancedMode = function (toggleElement) {
                try {
                    console.log('üîÑ Toggling advanced mode...');

                    const card = toggleElement.closest('.datacard');
                    if (!card) {
                        console.error('‚ùå Could not find parent datacard');
                        return;
                    }

                    const defaultMode = card.querySelector('.pricing-mode-default');
                    const advancedMode = card.querySelector('.pricing-mode-advanced');

                    if (!defaultMode || !advancedMode) {
                        console.error('‚ùå Could not find pricing mode elements');
                        console.log('Default mode:', defaultMode);
                        console.log('Advanced mode:', advancedMode);
                        return;
                    }

                    const isAdvanced = advancedMode.style.display === 'block';
                    console.log('Current state - isAdvanced:', isAdvanced);

                    if (isAdvanced) {
                        // Switch to default mode
                        advancedMode.style.display = 'none';
                        defaultMode.style.display = 'block';
                        toggleElement.classList.remove('expanded');
                        console.log('‚úÖ Switched to default mode');
                    } else {
                        // Switch to advanced mode
                        defaultMode.style.display = 'none';
                        advancedMode.style.display = 'block';
                        toggleElement.classList.add('expanded');
                        console.log('‚úÖ Switched to advanced mode');
                    }
                } catch (error) {
                    console.error('‚ùå Error toggling advanced mode:', error);
                }
            }

        </script>

        <!-- Core Application Logic -->
        <script>
            // Global state for unsaved changes tracking
            let hasUnsavedChanges = false;
            let currentFileName = '';
            let configFilesPath = ''; // Will be set when user provides path
            let validationConfig = null; // Will store loaded config

            // Percentage allocation state
            let productPercentages = new Map(); // symbol -> {percentage, isDirty}

            // Percentage validation and management functions
            function updateAllocationDisplay() {
                const allocationDisplay = document.getElementById('allocationDisplay');
                const allocationPercentage = document.getElementById('allocationPercentage');

                if (!allocationDisplay || !allocationPercentage) return;

                const total = calculateTotalPercentage();

                allocationPercentage.textContent = `${total}%`;

                // Update styling based on validation
                if (total === 100 && !hasZeroPercentProducts()) {
                    allocationDisplay.classList.remove('invalid');
                } else {
                    allocationDisplay.classList.add('invalid');
                }

                updateGenerateButtonState();
            }

            function calculateTotalPercentage() {
                let total = 0;
                document.querySelectorAll('.percentage-input').forEach(input => {
                    const value = parseInt(input.value) || 0;
                    total += value;
                });
                return total;
            }

            function hasZeroPercentProducts() {
                return Array.from(document.querySelectorAll('.percentage-input')).some(input => {
                    return (parseInt(input.value) || 0) === 0;
                });
            }

            function updateGenerateButtonState() {
                const generateBtn = document.getElementById('generateDataset');
                if (!generateBtn) return;

                const total = calculateTotalPercentage();
                const hasZeros = hasZeroPercentProducts();

                // Enable only when total is exactly 100% AND no products have 0%
                generateBtn.disabled = (total !== 100) || hasZeros || IS_DEMO_MODE;
            }

            function validatePercentageInput(input) {
                const value = parseInt(input.value) || 0;
                const symbol = input.closest('.datacard').dataset.symbol;

                // Clear previous validation state
                input.classList.remove('invalid');

                // Check for 0% (always invalid)
                if (value === 0) {
                    input.classList.add('invalid');
                    updateAllocationDisplay();
                    return false;
                }

                // Mark this product as dirty
                productPercentages.set(symbol, { percentage: value, isDirty: true });

                // Check for overallocation - highlight the input that caused it
                const total = calculateTotalPercentage();
                if (total > 100) {
                    input.classList.add('invalid');
                }

                updateAllocationDisplay();
                return total <= 100 && value > 0;
            }

            function redistributeCleanPercentages() {
                const datacards = document.querySelectorAll('.datacard');
                const cleanProducts = [];
                const dirtyProducts = [];
                let dirtyTotal = 0;

                // Categorize products as clean or dirty
                datacards.forEach(card => {
                    const symbol = card.dataset.symbol;
                    const input = card.querySelector('.percentage-input');
                    const percentage = parseInt(input.value) || 0;

                    const productState = productPercentages.get(symbol);

                    if (productState && productState.isDirty) {
                        dirtyProducts.push({ symbol, input, percentage });
                        dirtyTotal += percentage;
                    } else {
                        cleanProducts.push({ symbol, input, percentage });
                    }
                });

                const remainingPercent = 100 - dirtyTotal;

                if (cleanProducts.length > 0 && remainingPercent > 0) {
                    // Redistribute evenly among clean products
                    const evenSplit = Math.floor(remainingPercent / cleanProducts.length);
                    const remainder = remainingPercent % cleanProducts.length;

                    cleanProducts.forEach((product, index) => {
                        // Give first few products an extra percent if there's a remainder
                        const newPercentage = evenSplit + (index < remainder ? 1 : 0);
                        product.input.value = newPercentage;

                        // Update state but keep as clean
                        productPercentages.set(product.symbol, { percentage: newPercentage, isDirty: false });
                    });

                    // Return percentage for new product when all existing are redistributed
                    const newProductCount = cleanProducts.length + 1;
                    const newEvenSplit = Math.floor(remainingPercent / newProductCount);
                    return newEvenSplit;
                } else if (remainingPercent > 0) {
                    // No clean products, new product gets all remaining percentage
                    return remainingPercent;
                } else {
                    // All dirty products account for 100% or more, new product gets 0%
                    return 0;
                }
            }

            // Load validation configuration
            async function loadValidationConfig() {
                // In demo mode, use fallback config directly
                if (IS_DEMO_MODE) {
                    validationConfig = {
                        fileSystem: {
                            exchangeDirectories: {
                                "CME": "./datasets/cme",
                                "NYSE": "./datasets/nyse",
                                "NASDAQ": "./datasets/nsdq"
                            },
                            fileExtensions: {
                                "CME": ".cme",
                                "NYSE": ".nyse",
                                "NASDAQ": ".nsdq"
                            }
                        },
                        sliderConfig: {
                            basePrice: {
                                min: 1,
                                max: 500,
                                step: 0.50,
                                default: 195.50
                            },
                            spread: {
                                min: 0.01,
                                max: 5.0,
                                step: 0.01,
                                default: 0.12
                            },
                            bidPrice: {
                                min: 1,
                                max: 500,
                                step: 0.01,
                                default: 195.44
                            },
                            askPrice: {
                                min: 1,
                                max: 500,
                                step: 0.01,
                                default: 195.56
                            },
                            bidQuantity: {
                                min: 100,
                                max: 50000,
                                step: 100,
                                default: 1500
                            },
                            askQuantity: {
                                min: 100,
                                max: 50000,
                                step: 100,
                                default: 1200
                            },
                            bidWeight: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 48
                            },
                            askWeight: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 52
                            },
                            volatility: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 18
                            },
                            trend: {
                                min: -50,
                                max: 50,
                                step: 1,
                                default: 3
                            },
                            percentage: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 0
                            }
                        }
                    };
                    console.log('‚úÖ Demo validation config loaded');
                    return;
                }

                try {
                    const response = await fetch('/command-center/apps/dataset-generator/config/validation-rules.json');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    validationConfig = await response.json();
                    console.log('‚úÖ Validation config loaded:', validationConfig);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to load validation config, using fallback:', error.message);
                    // Fallback config
                    validationConfig = {
                        fileSystem: {
                            exchangeDirectories: {
                                "CME": "./datasets/cme",
                                "NYSE": "./datasets/nyse",
                                "NASDAQ": "./datasets/nsdq"
                            },
                            fileExtensions: {
                                "CME": ".cme",
                                "NYSE": ".nyse",
                                "NASDAQ": ".nsdq"
                            }
                        },
                        sliderConfig: {
                            basePrice: {
                                min: 1,
                                max: 500,
                                step: 0.50,
                                default: 195.50
                            },
                            spread: {
                                min: 0.01,
                                max: 5.0,
                                step: 0.01,
                                default: 0.12
                            },
                            bidPrice: {
                                min: 1,
                                max: 500,
                                step: 0.01,
                                default: 195.44
                            },
                            askPrice: {
                                min: 1,
                                max: 500,
                                step: 0.01,
                                default: 195.56
                            },
                            bidQuantity: {
                                min: 100,
                                max: 50000,
                                step: 100,
                                default: 1500
                            },
                            askQuantity: {
                                min: 100,
                                max: 50000,
                                step: 100,
                                default: 1200
                            },
                            bidWeight: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 48
                            },
                            askWeight: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 52
                            },
                            volatility: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 18
                            },
                            trend: {
                                min: -50,
                                max: 50,
                                step: 1,
                                default: 3
                            },
                            percentage: {
                                min: 0,
                                max: 100,
                                step: 1,
                                default: 0
                            }
                        }
                    };
                }
            }

            // Populate file dropdown based on selected exchange
            async function populateFileDropdown(exchange) {
                const fileDropdownMenu = document.getElementById('fileDropdownMenu');
                if (!fileDropdownMenu || !validationConfig) {
                    console.warn('File dropdown or config not available');
                    return;
                }

                const fileExtension = validationConfig.fileSystem.fileExtensions[exchange];
                const directory = validationConfig.fileSystem.exchangeDirectories[exchange];

                if (!fileExtension || !directory) {
                    console.warn(`No configuration found for exchange: ${exchange}`);
                    return;
                }

                try {
                    // In demo mode, show mock files
                    if (IS_DEMO_MODE) {
                        const mockFiles = [
                            `sample_strategy${fileExtension}`,
                            `backtest_data${fileExtension}`,
                            `live_test${fileExtension}`,
                            `momentum_algo${fileExtension}`
                        ];

                        fileDropdownMenu.innerHTML = '';

                        if (mockFiles.length === 0) {
                            fileDropdownMenu.innerHTML = '<div style="padding: 1em; text-align: center; color: rgba(255,255,255,0.5); font-style: italic;">No files available</div>';
                            return;
                        }

                        mockFiles.forEach(fileName => {
                            const fileItem = document.createElement('div');
                            fileItem.style.cssText = `
                            padding: 0.75em 1em;
                            cursor: pointer;
                            border-bottom: 1px solid rgba(255,255,255,0.1);
                            transition: background 0.2s ease;
                            color: rgba(255,255,255,0.9);
                        `;
                            fileItem.textContent = fileName;

                            fileItem.addEventListener('mouseenter', () => {
                                fileItem.style.background = 'rgba(107, 182, 255, 0.1)';
                            });
                            fileItem.addEventListener('mouseleave', () => {
                                fileItem.style.background = 'none';
                            });

                            fileItem.addEventListener('click', () => {
                                const fileDropdownText = document.getElementById('fileDropdownText');
                                if (fileDropdownText) {
                                    fileDropdownText.textContent = fileName.replace(fileExtension, '');
                                }
                                fileDropdownMenu.style.display = 'none';
                            });

                            fileDropdownMenu.appendChild(fileItem);
                        });
                    } else {
                        // In production mode, this would fetch real files from the server
                        // For now, show placeholder
                        fileDropdownMenu.innerHTML = '<div style="padding: 1em; text-align: center; color: rgba(255,255,255,0.5); font-style: italic;">File loading not implemented in current version</div>';
                    }

                } catch (error) {
                    console.error('Error loading files:', error);
                    fileDropdownMenu.innerHTML = '<div style="padding: 1em; text-align: center; color: #ff5858; font-style: italic;">Error loading files</div>';
                }
            }

            // Handle exchange change to update file dropdown
            function handleExchangeChange() {
                const exchangeSelect = document.getElementById('exchangeSelect');
                if (exchangeSelect && validationConfig) {
                    const selectedExchange = exchangeSelect.value;
                    populateFileDropdown(selectedExchange);

                    // Reset file dropdown text
                    const fileDropdownText = document.getElementById('fileDropdownText');
                    if (fileDropdownText) {
                        fileDropdownText.textContent = 'Select File';
                    }
                }
            }

            // Demo mode initialization
            function initializeDemoMode() {
                if (IS_DEMO_MODE) {
                    // Show demo banner
                    const banner = document.getElementById('demo-banner');
                    if (banner) {
                        banner.style.display = 'block';
                    }

                    // Disable generate button permanently
                    const generateBtn = document.getElementById('generateDataset');
                    if (generateBtn) {
                        generateBtn.disabled = true;
                        generateBtn.style.opacity = '0.5';
                        generateBtn.style.cursor = 'not-allowed';
                        generateBtn.title = 'Generation disabled in demo mode';

                        // Add click handler to show demo message
                        generateBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            alert('Dataset generation is disabled in demo mode. This allows you to explore the interface safely.');
                        });
                    }

                    // Create sample datacard after a brief delay to ensure DOM is ready
                    setTimeout(() => {
                        createSampleDatacard();
                    }, 100);
                }
            }

            // Create a sample datacard to demonstrate functionality
            function createSampleDatacard() {
                console.log('üîÑ Creating sample datacard...');

                const datacardContainer = document.getElementById('datacardContainer');
                if (!datacardContainer) {
                    console.error('‚ùå Datacard container not found');
                    return;
                }

                // Check if createDetailedDatacard function exists
                if (typeof createDetailedDatacard !== 'function') {
                    console.error('‚ùå createDetailedDatacard function not found');
                    return;
                }

                try {
                    // Create sample AAPL datacard with realistic trading parameters
                    console.log('üîÑ Calling createDetailedDatacard...');
                    const sampleCard = createDetailedDatacard('AAPL');

                    if (sampleCard) {
                        datacardContainer.appendChild(sampleCard);
                        console.log('‚úÖ Sample card created and appended');

                        // Ensure card starts in default (spread-based) mode
                        const defaultMode = sampleCard.querySelector('.pricing-mode-default');
                        const advancedMode = sampleCard.querySelector('.pricing-mode-advanced');
                        const advancedToggle = sampleCard.querySelector('.advanced-toggle');

                        if (defaultMode && advancedMode && advancedToggle) {
                            defaultMode.style.display = 'block';
                            advancedMode.style.display = 'none';
                            advancedToggle.classList.remove('expanded');
                            console.log('‚úÖ Sample card set to default (spread-based) mode');
                        }

                        // Set realistic values for AAPL
                        const ranges = sampleCard.querySelectorAll('.range-input');
                        const values = {
                            basePrice: 175,      // ~$175 for AAPL
                            spread: 0.5,         // 0.5% spread
                            bidWeight: 45,       // Slightly bid-heavy
                            askWeight: 55,       // Slightly ask-heavy
                            bidQuantity: 250,    // 250 shares
                            askQuantity: 300,    // 300 shares
                            volatility: 25,      // 25% volatility
                            trend: 5             // Slight upward trend
                        };

                        // Apply values to the sample card
                        const controls = sampleCard.querySelectorAll('.range-control');
                        controls.forEach(control => {
                            const label = control.querySelector('.range-label')?.textContent;
                            const input = control.querySelector('.range-input');
                            const valueSpan = control.querySelector('.value');

                            let newValue;
                            switch (label) {
                                case 'Base Price': newValue = values.basePrice; break;
                                case 'Spread': newValue = values.spread; break;
                                case 'Bid Weight': newValue = values.bidWeight; break;
                                case 'Ask Weight': newValue = values.askWeight; break;
                                case 'Bid Quantity': newValue = values.bidQuantity; break;
                                case 'Ask Quantity': newValue = values.askQuantity; break;
                                case 'Volatility': newValue = values.volatility; break;
                                case 'Trend': newValue = values.trend; break;
                            }

                            if (newValue !== undefined && input && valueSpan) {
                                input.value = newValue;
                                valueSpan.textContent = newValue;
                            }
                        });

                        console.log('‚úÖ Sample AAPL datacard created with realistic trading parameters');
                    } else {
                        console.error('‚ùå createDetailedDatacard returned null/undefined');
                    }
                } catch (error) {
                    console.error('‚ùå Error creating sample datacard:', error);
                }
            }

            // Mark changes as unsaved
            function markUnsavedChanges() {
                hasUnsavedChanges = true;
            }

            // Mark changes as saved
            function markChangesSaved() {
                hasUnsavedChanges = false;
            }

            // Show unsaved changes warning
            function showUnsavedChangesWarning(callback) {
                if (hasUnsavedChanges) {
                    const confirmed = confirm(
                        `You have unsaved changes that will be lost.\\n\\nDo you want to continue?`
                    );
                    if (confirmed) {
                        callback();
                    }
                    return confirmed;
                } else {
                    callback();
                    return true;
                }
            }

            // Load configuration files from path
            async function loadConfigurationFiles() {
                const fileList = document.getElementById('fileList');

                if (!configFilesPath) {
                    fileList.innerHTML = '<div class="file-item" style="padding: 0.6em 1em; color: rgba(255,255,255,0.5); font-style: italic;">No configuration path set</div>';
                    return;
                }

                try {
                    // This will be replaced with actual file loading logic
                    fileList.innerHTML = '<div class="file-item loading" style="padding: 0.6em 1em; color: rgba(255,255,255,0.5); font-style: italic;">Loading files...</div>';

                    // Placeholder for file loading - will be implemented when path is provided
                    // For now, show some example files
                    setTimeout(() => {
                        const exampleFiles = [
                            'default.json',
                            'nasdaq_setup.json',
                            'cme_futures.json',
                            'test_config.json'
                        ];

                        fileList.innerHTML = '';
                        exampleFiles.forEach(fileName => {
                            const fileItem = document.createElement('button');
                            fileItem.className = 'file-item dropdown-item';
                            fileItem.style.cssText = 'width: 100%; border: none; background: none; color: #fff; padding: 0.6em 1em; text-align: left; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; justify-content: space-between;';

                            fileItem.innerHTML = `
                            <span style="display: flex; align-items: center; gap: 0.5em;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                </svg>
                                ${fileName}
                            </span>
                            ${currentFileName === fileName ? '<span style="color: #6bb6ff; font-size: 0.8em;">‚óè</span>' : ''}
                        `;

                            fileItem.addEventListener('mouseenter', () => {
                                fileItem.style.background = 'rgba(107, 182, 255, 0.1)';
                            });
                            fileItem.addEventListener('mouseleave', () => {
                                fileItem.style.background = 'none';
                            });

                            fileItem.addEventListener('click', () => {
                                showUnsavedChangesWarning(() => {
                                    loadConfiguration(fileName);
                                });
                            });

                            fileList.appendChild(fileItem);
                        });
                    }, 500);

                } catch (error) {
                    console.error('Error loading configuration files:', error);
                    fileList.innerHTML = '<div class="file-item error" style="padding: 0.6em 1em; color: #ff5858; font-style: italic;">Error loading files</div>';
                }
            }

            // Load a specific configuration
            function loadConfiguration(fileName) {
                console.log(`Loading configuration: ${fileName}`);
                currentFileName = fileName;

                // Update file dropdown text
                const fileDropdownText = document.getElementById('fileDropdownText');
                if (fileDropdownText) {
                    fileDropdownText.textContent = fileName.replace('.json', '');
                }

                // Mark as saved since we just loaded
                markChangesSaved();

                // TODO: Actual file loading logic will go here
                console.log(`‚úÖ Configuration "${fileName}" loaded`);
            }

            // Save configuration
            function saveConfiguration() {
                // Since this is now just a dropdown, we'll need a different way to get the filename
                // For now, we'll use a prompt until we implement proper save functionality
                const fileName = prompt('Enter configuration name:');

                if (!fileName || !fileName.trim()) {
                    alert('Please enter a valid file name');
                    return;
                }

                const fullFileName = fileName.trim().endsWith('.json') ? fileName.trim() : fileName.trim() + '.json';

                console.log(`Saving configuration as: ${fullFileName}`);

                // TODO: Actual save logic will go here
                currentFileName = fullFileName;
                markChangesSaved();

                // Update dropdown text to show loaded file
                const fileDropdownText = document.getElementById('fileDropdownText');
                if (fileDropdownText) {
                    fileDropdownText.textContent = fileName.trim().replace('.json', '');
                }

                console.log(`‚úÖ Configuration saved as "${fullFileName}"`);
            }

            // Setup dropdown functionality
            async function setupDropdownFunctionality() {
                // Load validation config first
                await loadValidationConfig();

                const dropdownBtn = document.getElementById('fileDropdownBtn');
                const dropdownMenu = document.getElementById('fileDropdownMenu');
                const exchangeSelect = document.getElementById('exchangeSelect');

                if (dropdownBtn && dropdownMenu) {
                    dropdownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isVisible = dropdownMenu.style.display === 'block';
                        dropdownMenu.style.display = isVisible ? 'none' : 'block';

                        // Populate dropdown when opened
                        if (!isVisible && exchangeSelect) {
                            populateFileDropdown(exchangeSelect.value);
                        }
                    });

                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.dropdown-container')) {
                            dropdownMenu.style.display = 'none';
                        }
                    });

                    console.log('‚úÖ File dropdown functionality ready');
                }

                // Set up exchange change listener
                if (exchangeSelect) {
                    exchangeSelect.addEventListener('change', handleExchangeChange);

                    // Initial population
                    populateFileDropdown(exchangeSelect.value);
                }

                // Track changes on form inputs to mark unsaved changes
                const inputs = document.querySelectorAll('#messageCount, #symbolInput, #exchangeSelect');
                inputs.forEach(input => {
                    input.addEventListener('input', markUnsavedChanges);
                    input.addEventListener('change', markUnsavedChanges);
                });

                // Setup utility icon dropdowns (info and search)
                setupUtilityDropdowns();
            }

            // Setup utility icon dropdown functionality
            function setupUtilityDropdowns() {
                // Info dropdown
                const infoIcon = document.getElementById('infoIcon');
                const infoDropdown = document.getElementById('infoDropdown');

                if (infoIcon && infoDropdown) {
                    infoIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isVisible = infoDropdown.style.display === 'block';

                        // Close search dropdown if open
                        const searchDropdown = document.getElementById('searchDropdown');
                        if (searchDropdown) {
                            searchDropdown.classList.remove('show');
                        }

                        infoDropdown.style.display = isVisible ? 'none' : 'block';
                    });
                }

                // Search dropdown
                const searchIcon = document.getElementById('searchIcon');
                const searchDropdown = document.getElementById('searchDropdown');

                if (searchIcon && searchDropdown) {
                    searchIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isVisible = searchDropdown.classList.contains('show');

                        // Close info dropdown if open
                        if (infoDropdown) {
                            infoDropdown.style.display = 'none';
                        }

                        if (isVisible) {
                            searchDropdown.classList.remove('show');
                        } else {
                            searchDropdown.classList.add('show');
                            // Focus on search input when opened
                            const searchInput = searchDropdown.querySelector('.search-input');
                            if (searchInput) {
                                setTimeout(() => searchInput.focus(), 100);
                            }
                        }
                    });
                }

                // Close utility dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.utility-icon')) {
                        // Close info dropdown
                        if (infoDropdown) {
                            infoDropdown.style.display = 'none';
                        }
                        // Close search dropdown
                        if (searchDropdown) {
                            searchDropdown.classList.remove('show');
                        }
                    }
                });

                // Track datacard changes (will work with both real app and fallback)
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // New datacards added - mark as changed
                            markUnsavedChanges();
                        }
                    });
                });

                const datacardContainer = document.getElementById('datacardContainer');
                if (datacardContainer) {
                    observer.observe(datacardContainer, { childList: true, subtree: true });
                }
            }
        </script>

        <!-- Info Dropdown Script -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Info dropdown functionality
                var infoBtn = document.getElementById('infoIconBtn');
                var dropdown = document.getElementById('infoDropdown');
                if (infoBtn && dropdown) {
                    infoBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
                    });

                    document.addEventListener('click', function (e) {
                        if (!infoBtn.contains(e.target) && !dropdown.contains(e.target)) {
                            dropdown.style.display = 'none';
                        }
                    });

                    infoBtn.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape') dropdown.style.display = 'none';
                    });
                }

                // Basic spinner functionality fallback
                const messageCountInput = document.getElementById('messageCount');
                const spinnerUp = document.querySelector('.spinner-up');
                const spinnerDown = document.querySelector('.spinner-down');

                // Validation function for message count
                function validateMessageCount(value) {
                    const messageCount = parseInt(value) || 0;
                    const spinnerControl = messageCountInput.closest('.spinner-control');

                    if (spinnerControl) {
                        // Remove existing adorner
                        spinnerControl.removeAttribute('data-adorner');

                        // Apply adorner based on threshold from config (1000)
                        if (messageCount < 1000) {
                            spinnerControl.setAttribute('data-adorner', 'red');
                        } else {
                            spinnerControl.setAttribute('data-adorner', 'green');
                        }
                    }

                    // Update spinner button states (but allow exploration in demo mode)
                    if (spinnerDown) {
                        spinnerDown.disabled = messageCount <= 1000;
                    }

                    // In demo mode, generate button stays disabled regardless of validation
                    const generateBtn = document.getElementById('generateDataset');
                    if (generateBtn && !IS_DEMO_MODE) {
                        // Only enable generate button if not in demo mode and validation passes
                        generateBtn.disabled = messageCount < 1000;
                    }

                    return messageCount >= 1000;
                }

                if (messageCountInput && spinnerUp && spinnerDown) {
                    // Set default value and validate
                    messageCountInput.value = 1000;
                    validateMessageCount(1000);

                    // Add input event listeners for typing and pasting
                    messageCountInput.addEventListener('input', (e) => {
                        validateMessageCount(e.target.value);
                    });

                    messageCountInput.addEventListener('paste', (e) => {
                        // Use timeout to get the value after paste
                        setTimeout(() => {
                            validateMessageCount(messageCountInput.value);
                        }, 0);
                    });

                    spinnerUp.addEventListener('click', () => {
                        const current = parseInt(messageCountInput.value) || 0;
                        const newValue = current + 500;
                        messageCountInput.value = newValue;
                        validateMessageCount(newValue);
                    });

                    spinnerDown.addEventListener('click', () => {
                        const current = parseInt(messageCountInput.value) || 0;
                        const newValue = Math.max(1000, current - 500);  // Don't go below 1000
                        messageCountInput.value = newValue;
                        validateMessageCount(newValue);
                    });
                }

                // Don't setup fallback symbol functionality - let the real app handle it
                console.log('Basic UI controls initialized. Waiting for full application to load...');

                // Initialize percentage validation for existing datacards
                initializePercentageValidation();
            });

            // Initialize percentage validation for existing datacards
            function initializePercentageValidation() {
                const datacards = document.querySelectorAll('.datacard');

                datacards.forEach(card => {
                    const symbol = card.dataset.symbol;
                    const percentageInput = card.querySelector('.percentage-input');

                    if (percentageInput && symbol) {
                        // Initialize tracking state
                        const initialValue = parseInt(percentageInput.value) || 0;
                        productPercentages.set(symbol, { percentage: initialValue, isDirty: false });

                        // Add event listeners
                        percentageInput.addEventListener('input', (e) => {
                            validatePercentageInput(e.target);
                        });

                        percentageInput.addEventListener('change', (e) => {
                            validatePercentageInput(e.target);
                        });

                        // Add remove button functionality
                        const removeBtn = card.querySelector('.remove-symbol');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', () => {
                                productPercentages.delete(symbol);
                                card.remove();
                                redistributeCleanPercentages();
                                updateAllocationDisplay();
                            });
                        }
                    }
                });

                // Initial validation update
                updateAllocationDisplay();
                console.log('‚úÖ Percentage validation initialized for existing datacards');
            });
        </script>
    </body>

</html>
